name: Keep Scheduled Workflows Alive

on:
  schedule:
    # Run on the 1st of each month (checks for activity in the last 50 days before taking action)
    # This conservative frequency ensures we never hit the 60-day GitHub inactivity limit
    # even accounting for holidays, weekends, or workflow execution delays
    - cron: "0 0 1 * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  keep-alive:
    name: Keep repository active
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Git checkout
      uses: actions/checkout@v4

    - name: Check for recent activity
      id: check_activity
      env:
        GH_TOKEN: ${{ github.token }}
      shell: bash
      run: |
        # Check for any activity in the last 50 days
        cutoff_date=$(date -u -d '50 days ago' '+%Y-%m-%dT%H:%M:%SZ')
        echo "Checking for activity since: $cutoff_date"
        
        # Check for recent commits
        recent_commits=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${{ github.repository }}/commits?since=$cutoff_date&per_page=1" \
          --jq 'length' 2>/dev/null || echo "0")
        
        # Check for recent issues/PRs
        recent_issues=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${{ github.repository }}/issues?since=$cutoff_date&per_page=1&state=all" \
          --jq 'length' 2>/dev/null || echo "0")
        
        echo "Recent commits: $recent_commits"
        echo "Recent issues/PRs: $recent_issues"
        
        if [ "$recent_commits" -gt 0 ] || [ "$recent_issues" -gt 0 ]; then
          echo "Recent activity detected. No action needed."
          echo "needs_activity=false" >> $GITHUB_OUTPUT
        else
          echo "No recent activity. Will create keep-alive activity."
          echo "needs_activity=true" >> $GITHUB_OUTPUT
        fi

    - name: Create and close PR to maintain activity
      if: steps.check_activity.outputs.needs_activity == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      shell: bash
      run: |
        # Configure git
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create a unique branch name
        branch_name="keep-alive-$(date +%Y%m%d-%H%M%S)"
        
        # Create a new branch and make an empty commit
        git checkout -b "$branch_name"
        git commit --allow-empty -m "chore: keep scheduled workflows alive

This automated commit ensures scheduled workflows remain active.
GitHub disables scheduled workflows after 60 days of repository inactivity."
        
        git push --set-upstream origin "$branch_name"
        
        # Create PR
        pr_url=$(gh pr create \
          --head "$branch_name" \
          --base main \
          --title "chore: keep scheduled workflows alive" \
          --body "This automated PR is created to prevent scheduled workflows from being disabled due to inactivity.

GitHub automatically disables scheduled workflows when no repository activity has occurred in 60 days. This PR ensures continuous operation of our scheduled builds and tests.

This PR contains an empty commit and will be automatically closed without merging.")
        
        echo "Created PR: $pr_url"
        
        # Extract PR number from URL
        pr_number=$(echo "$pr_url" | grep -o '[0-9]*$')
        
        if [ -n "$pr_number" ]; then
          # Close the PR immediately
          gh pr close "$pr_number" --comment "Closing this keep-alive PR as its purpose (maintaining repository activity) has been fulfilled."
          echo "Closed PR #$pr_number"
          
          # Clean up the branch
          git push origin --delete "$branch_name"
          echo "Deleted branch: $branch_name"
        else
          echo "Warning: Could not extract PR number from URL: $pr_url"
          echo "The branch $branch_name was created but PR may not have been closed."
        fi
